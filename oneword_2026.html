<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>One Word</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#121429;
      --line:rgba(255,255,255,.10);
      --txt:#f3f4ff;
      --muted:rgba(243,244,255,.70);
      --accent:#7c5cff;
      --ok:#00d084;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
      background: radial-gradient(1100px 520px at 15% 0%, rgba(124,92,255,.18), transparent 60%),
                  radial-gradient(900px 520px at 85% 10%, rgba(0,210,255,.10), transparent 55%),
                  var(--bg);
      color:var(--txt);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 40px}
    .bar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:14px 14px;border:1px solid var(--line);border-radius:16px;
      background:linear-gradient(180deg, rgba(18,20,41,.88), rgba(15,16,32,.70));
      box-shadow:0 10px 30px rgba(0,0,0,.32);
    }
    .title{font-weight:900;font-size:18px;letter-spacing:.2px}
    .hint{font-size:12px;color:var(--muted)}
    .right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .chip{
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.16);
      font-size:12px;color:var(--muted);
    }
    .chip.ok{border-color:rgba(0,208,132,.35);background:rgba(0,208,132,.08);color:rgba(243,244,255,.86)}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--txt);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;user-select:none;
      transition:.15s transform,.15s background,.15s border-color;
      font-size:13px;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.07);border-color:rgba(255,255,255,.18)}
    .btn.primary{border-color:rgba(124,92,255,.55);background:rgba(124,92,255,.16)}
    .btn:disabled{opacity:.45;cursor:not-allowed;transform:none}
    input[type="file"]{display:none}

    .panel{
      margin-top:14px;
      padding:14px;border-radius:16px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(18,20,41,.82), rgba(15,16,32,.66));
      box-shadow:0 10px 30px rgba(0,0,0,.28);
      min-height: 180px;
    }
    .topline{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .step{font-weight:900;font-size:16px}
    .counter{font-size:12px;color:var(--muted)}
    .grid{
      margin-top:12px;
      display:grid;grid-template-columns:repeat(3,1fr);
      gap:10px;
    }
    @media (max-width:780px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px 14px 12px;
      background:rgba(0,0,0,.14);
      cursor:pointer;
      transition:.15s transform,.15s border-color,.15s background;
      min-height:78px;
    }
    .card:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.05)}
    .en{font-weight:950;font-size:18px;letter-spacing:.4px}
    .ko{margin-top:6px;font-size:12px;color:var(--muted)}
    .card.sel{
      border-color:rgba(124,92,255,.9);
      background:linear-gradient(180deg, rgba(124,92,255,.22), rgba(0,0,0,.12));
    }

    /* tournament */
    .matchGrid{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:760px){.matchGrid{grid-template-columns:1fr}}
    .match{
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px 16px;
      background:rgba(0,0,0,.14);
      cursor:pointer;
      transition:.15s transform,.15s border-color,.15s background;
      min-height:130px;
    }
    .match:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.05)}
    .matchEn{font-size:34px;font-weight:950;letter-spacing:1px}
    .matchKo{margin-top:10px;color:var(--muted);font-size:14px}

    /* result */
    .resultWord{font-weight:950;font-size:34px;letter-spacing:1px;margin-top:8px}
    .previewWrap{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){.previewWrap{grid-template-columns:1fr}}
    .preview{
      border:1px solid var(--line);
      border-radius:16px;overflow:hidden;
      background:#000;
      position:relative;
      width:100%;
      /* ✅ 미리보기 비율 고정: 늘어짐/찜그러짐 방지 */
      height:auto;
    }
    .preview.desk{aspect-ratio:16/9;}
    .preview.mob{aspect-ratio:9/16;}
    /* 구형 브라우저 대비(아주 좁은 화면에서도 최소 높이 확보) */
    .preview{min-height:220px;}
    .img{position:absolute;inset:0;background-size:cover;background-position:center}
    .word{position:absolute;left:50%;transform:translateX(-50%);color:#fff;font-weight:950;letter-spacing:2px;white-space:nowrap;text-shadow:0 8px 26px rgba(0,0,0,.55)}
    .year{position:absolute;left:50%;transform:translateX(-50%);color:rgba(255,255,255,.55);font-weight:900;letter-spacing:1px;text-shadow:0 8px 26px rgba(0,0,0,.55)}
    .cap{position:absolute;left:0;right:0;bottom:0;padding:10px 12px;border-top:1px solid var(--line);background:rgba(0,0,0,.25);font-size:12px;color:var(--muted)}

    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    /* background gallery */
    .bgGallery{display:flex;gap:10px;margin-top:12px;overflow-x:auto;padding:8px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.02)}
    .thumb{flex:0 0 120px;height:72px;border-radius:10px;border:1px solid var(--line);background-size:cover;background-position:center;cursor:pointer;position:relative}
    .thumb .name{position:absolute;left:8px;right:8px;bottom:6px;font-size:11px;color:var(--muted);text-shadow:0 2px 6px rgba(0,0,0,.55)}
    .thumb.sel{outline:3px solid rgba(124,92,255,.22);box-shadow:0 6px 18px rgba(124,92,255,.06)}
  </style>
</head>

<body>
<div class="wrap">
  <div class="bar">
    <div>
      <div class="title">원워드</div>
      <div class="hint" id="hint">배경 선택 → 카드 선택</div>
    </div>
    <div class="right">
      <span class="chip" id="bgChip">배경 미선택</span>
      <button class="btn primary" id="bgBtn" type="button">배경 선택</button>
      <button class="btn" id="useMyBtn" type="button">내 사진 쓰기</button>
      <button class="btn" id="resetBtn" type="button">리셋</button>
      <input id="bgFile" type="file" accept="image/*" multiple />
    </div>
  </div>

  <div id="bgGallery" class="bgGallery" aria-label="배경 갤러리"></div>

  <div class="panel" id="panel"></div>
</div>

<script>
(() => {
  // ====== 튜닝(원워드 위치) ======
  const YEAR_TEXT = "2026";
  const HORIZON_DESKTOP = 0.62;
  const HORIZON_MOBILE  = 0.73;

  const WORD_SIZE_DESKTOP = 140;
  const WORD_SIZE_MOBILE  = 120;
  const YEAR_SIZE_DESKTOP = 54;
  const YEAR_SIZE_MOBILE  = 46;
  const OVERLAY_ALPHA = 0.16;

  // ====== 단어 ======
  const WORDS = [
    {en:"ALIGN", ko:"정렬·우선순위"},
    {en:"REALIGN", ko:"재정렬·리셋"},
    {en:"PURPOSE", ko:"목적·의미"},
    {en:"MISSION", ko:"사명"},
    {en:"FOCUS", ko:"집중"},
    {en:"CLARITY", ko:"명확함"},
    {en:"COURAGE", ko:"용기"},
    {en:"EXECUTE", ko:"실행"},
    {en:"FINISH", ko:"완수"},
    {en:"COMPLETE", ko:"완성"},
    {en:"CONSISTENCY", ko:"꾸준함"},
    {en:"DISCIPLINE", ko:"훈련"},
    {en:"FLOW", ko:"몰입"},
    {en:"CALM", ko:"평안"},
    {en:"JOY", ko:"기쁨"},
    {en:"GRACE", ko:"은혜·여유"},
    {en:"THANKFUL", ko:"감사"},
    {en:"HOPE", ko:"소망"},
    {en:"TRUTH", ko:"진리"},
    {en:"WISDOM", ko:"지혜"},
    {en:"KINDNESS", ko:"친절"},
    {en:"LOVE", ko:"사랑"},
    {en:"SERVE", ko:"섬김"},
    {en:"GIVE", ko:"나눔"},          /* ✅ 여기 오타 수정됨 */
    {en:"BUILD", ko:"구축"},
    {en:"GROW", ko:"성장"},
    {en:"BLOOM", ko:"피어남"},
    {en:"RISE", ko:"일어섬"},
    {en:"ADVANCE", ko:"전진"},
    {en:"MOMENTUM", ko:"탄력"},
    {en:"MASTER", ko:"숙련"},
    {en:"ESSENTIAL", ko:"본질"},
    {en:"SIMPLICITY", ko:"단순함"},
    {en:"CLEAN", ko:"정돈"},
    {en:"ORDER", ko:"질서"},
    {en:"PRIORITY", ko:"우선순위"},
    {en:"ROOT", ko:"뿌리"},
    {en:"ANCHOR", ko:"기준"},
    {en:"STEADY", ko:"흔들림 없이"},
    {en:"FAITHFUL", ko:"충실함"},
    {en:"TRUST", ko:"신뢰"},
    {en:"LISTEN", ko:"경청"},
    {en:"LEARN", ko:"학습"},
    {en:"CREATE", ko:"창조"},
    {en:"DESIGN", ko:"설계"},
    {en:"VISION", ko:"큰 그림"},
    {en:"IMPACT", ko:"영향력"},
    {en:"VALUE", ko:"가치"},
    {en:"QUALITY", ko:"완성도"},
    {en:"ELEVATE", ko:"격상"},
    {en:"UPGRADE", ko:"업그레이드"},
    {en:"HEAL", ko:"회복"},
    {en:"RESTORE", ko:"복원"},
    {en:"BALANCE", ko:"균형"},
    {en:"PATIENCE", ko:"인내"},
    {en:"PRESENCE", ko:"현존"},
    {en:"STRENGTH", ko:"힘"},
    {en:"HUMILITY", ko:"겸손"},
    {en:"FREEDOM", ko:"자유"},
    {en:"HONOR", ko:"존귀"},
    {en:"BOLD", ko:"대담함"},
    {en:"DECIDE", ko:"결정"},
    {en:"COMMIT", ko:"헌신"},
    {en:"KEEP", ko:"지키기"},
    {en:"LIGHT", ko:"빛"},
    {en:"PEACE", ko:"평화"},
  ];

  // ====== utils ======
  const $ = (id) => document.getElementById(id);
  function shuffled(arr){
    const a = [...arr];
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  // ====== DOM ======
  const panel = $("panel");
  const hint = $("hint");
  const bgChip = $("bgChip");
  const bgBtn = $("bgBtn");
  const bgFile = $("bgFile");
  const bgGallery = $("bgGallery");
  const resetBtn = $("resetBtn");

  // ====== state ======
  const state = {
    bgImg: new Image(),
    bgReady: false,
    pools: [],
    poolIndex: 0,
    picks: [[],[],[]],
    mode: "pick",
    queue: [],
    next: [],
    a: null, b: null,
    final: null,
  };

  state.bgImg.decoding = "async";
  state.bgImg.onload = () => {
    state.bgReady = true;
    bgChip.textContent = "배경 로딩 완료";
    bgChip.classList.add("ok");
    // 자동 톤 분석
    try{
      state.bgTone = analyzeImageTone(state.bgImg);
    }catch(e){
      state.bgTone = null;
    }
    if(state.mode === "done") renderDone();
  };
  state.bgImg.onerror = () => {
    state.bgReady = false;
    bgChip.textContent = "배경 로딩 실패";
    bgChip.classList.remove("ok");
  };

  // gallery state
  const backgroundList = [];
  let selectedBgSrc = null;

  function markGallerySelection(src){
    const items = bgGallery.querySelectorAll('.thumb');
    items.forEach(it => {
      if(it.dataset.src === src) it.classList.add('sel'); else it.classList.remove('sel');
    });
  }

  function loadBgFromUrl(src, name){
    // set crossOrigin for remote images so canvas export isn't tainted
    try{
      if(/^https?:\/\//i.test(src)){
        state.bgImg.crossOrigin = 'anonymous';
      }else{
        // remove crossOrigin for local blobs/files
        try{ delete state.bgImg.crossOrigin; }catch(e){ state.bgImg.crossOrigin = null; }
      }
    }catch(e){}
    state.bgImg.src = src;
    bgChip.textContent = name ? `배경: ${name}` : "배경 로딩중…";
    bgChip.classList.remove("ok");
    selectedBgSrc = src;
    markGallerySelection(src);
  }

  function addBgThumb(src, name, select){
    const d = document.createElement('div');
    d.className = 'thumb';
    d.style.backgroundImage = `url(${src})`;
    d.dataset.src = src;
    const label = document.createElement('div');
    label.className = 'name';
    label.textContent = name || '';
    d.appendChild(label);
    d.onclick = () => loadBgFromUrl(src, name);
    bgGallery.appendChild(d);
    if(select) loadBgFromUrl(src, name);
  }

  function addBgFiles(files){
    const arr = Array.from(files);
    arr.forEach((f,idx)=>{
      const url = URL.createObjectURL(f);
      backgroundList.push({src:url,name:f.name});
      addBgThumb(url, f.name, idx===0);
    });
  }

  const SAMPLE_BACKGROUNDS = [
    // sample images (replace or remove if you provide your own)
    'https://images.unsplash.com/photo-1508780709619-79562169bc64?w=1200&q=60&auto=format&fit=crop',
    'https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=1200&q=60&auto=format&fit=crop',
    'https://images.unsplash.com/photo-1499346030926-9a72daac6c63?w=1200&q=60&auto=format&fit=crop'
  ];
  const LOCAL_DEFAULTS = ['./bg_default.png','./bg_default.jpg'];
  const REMOTE_DEFAULT = 'https://raw.githubusercontent.com/loromarble/oneword-2026/main/bg_default.png';

  function tryLoadLocalDefault(){
    // try multiple candidate filenames, pick first that loads; if none, fall back to remote default
    function tryOne(idx){
      if(idx >= LOCAL_DEFAULTS.length){
        // no local file — use remote default (GitHub raw). remote should allow CORS.
        addBgThumb(REMOTE_DEFAULT, '기본 배경', true);
        return;
      }
      const path = LOCAL_DEFAULTS[idx];
      const test = new Image();
      test.onload = () => {
        addBgThumb(path, '기본 배경', true);
      };
      test.onerror = () => {
        tryOne(idx+1);
      };
      test.src = path;
    }
    tryOne(0);
  }

  function populateSampleBackgrounds(){
    SAMPLE_BACKGROUNDS.forEach((u,i)=> addBgThumb(u, `샘플 ${i+1}`, i===0));
  }

  // ====== tone analysis ======
  function analyzeImageTone(img){
    const cw = 64, ch = 64;
    const c = document.createElement('canvas');
    c.width = cw; c.height = ch;
    const cx = c.getContext('2d');
    // draw scaled image centered
    const iw = img.naturalWidth, ih = img.naturalHeight;
    const scale = Math.max(cw/iw, ch/ih);
    const dw = iw*scale, dh = ih*scale;
    const dx = (cw - dw)/2, dy = (ch - dh)/2;
    cx.drawImage(img, dx, dy, dw, dh);
    try{
      const data = cx.getImageData(0,0,cw,ch).data;
      let tot = 0, count = 0;
      for(let i=0;i<data.length;i+=4){
        const r=data[i], g=data[i+1], b=data[i+2];
        const lum = 0.2126*r + 0.7152*g + 0.0722*b;
        tot += lum; count++;
      }
      const avg = tot/count; // 0-255
      // choose overlay and text color
      if(avg < 130){
        return {brightness: avg, overlay: `rgba(0,0,0,${OVERLAY_ALPHA})`, textColor: '#ffffff'};
      }else{
        // bright image -> add subtle dark overlay and use dark text
        return {brightness: avg, overlay: `rgba(0,0,0,${Math.min(0.36, OVERLAY_ALPHA+0.08)})`, textColor: '#ffffff'};
      }
    }catch(e){
      return {brightness:128, overlay:`rgba(0,0,0,${OVERLAY_ALPHA})`, textColor:'#ffffff'};
    }
  }

  bgBtn.onclick = () => bgFile.click();
  // explicit "use my photo" button (same action)
  const useMyBtn = $("useMyBtn");
  useMyBtn.onclick = () => bgFile.click();
  bgFile.onchange = (e) => {
    const files = e.target.files;
    if(!files || files.length===0) return;
    addBgFiles(files);
  };

  // preload sample thumbs (try local default first)
  tryLoadLocalDefault();

  resetBtn.onclick = () => init();

  // ====== init pools: 21x3 ======
  function init(){
    const base = shuffled(WORDS).slice(0, 63);
    state.pools = [base.slice(0,21), base.slice(21,42), base.slice(42,63)];
    state.poolIndex = 0;
    state.picks = [[],[],[]];
    state.mode = "pick";
    state.queue = [];
    state.next = [];
    state.a = null; state.b = null;
    state.final = null;

    hint.textContent = "배경 선택 → 카드 선택";
    renderPick();
  }

  // ====== pick UI ======
  function renderPick(){
    state.mode = "pick";
    const pool = state.pools[state.poolIndex];
    const picked = state.picks[state.poolIndex];

    panel.innerHTML = `
      <div class="topline">
        <div class="step">${state.poolIndex+1}/3</div>
        <div class="counter"><b>${picked.length}</b>/7</div>
      </div>
      <div class="grid" id="grid"></div>
      <div class="row">
        <button class="btn primary" id="nextBtn" ${picked.length===7 ? "" : "disabled"}>다음</button>
      </div>
    `;

    const grid = panel.querySelector("#grid");
    pool.forEach(w => {
      const c = document.createElement("div");
      c.className = "card" + (picked.some(x=>x.en===w.en) ? " sel" : "");
      c.innerHTML = `<div class="en">${w.en}</div><div class="ko">${w.ko}</div>`;
      c.onclick = () => {
        const idx = picked.findIndex(x=>x.en===w.en);
        if(idx>=0){
          picked.splice(idx,1);
          c.classList.remove("sel");
        }else{
          if(picked.length>=7) return;
          picked.push(w);
          c.classList.add("sel");
        }
        panel.querySelector(".counter").innerHTML = `<b>${picked.length}</b>/7`;
        panel.querySelector("#nextBtn").disabled = (picked.length!==7);
      };
      grid.appendChild(c);
    });

    panel.querySelector("#nextBtn").onclick = () => {
      if(picked.length!==7) return;
      if(state.poolIndex < 2){
        state.poolIndex += 1;
        renderPick();
      }else{
        startTournament();
      }
    };
  }

  // ====== tournament (SAFE) ======
  function startTournament(){
    state.mode = "tour";
    hint.textContent = "둘 중 하나 선택";
    const list = [...state.picks[0], ...state.picks[1], ...state.picks[2]];
    state.queue = shuffled(list);
    state.next = [];
    state.final = null;
    stepMatch();
  }

  function stepMatch(){
    if(state.queue.length === 1 && state.next.length === 0){
      state.final = state.queue[0];
      return renderDone();
    }

    if(state.queue.length === 0){
      state.queue = shuffled(state.next);
      state.next = [];
    }

    if(state.queue.length % 2 === 1){
      state.next.push(state.queue.pop());
    }

    state.a = state.queue.shift();
    state.b = state.queue.shift();

    if(!state.a || !state.b){
      if(state.a) state.next.push(state.a);
      if(state.b) state.next.push(state.b);
      state.a = null; state.b = null;
      if(state.queue.length===0 && state.next.length===1){
        state.final = state.next[0];
        return renderDone();
      }
      return stepMatch();
    }

    renderMatch(state.a, state.b);
  }

  function renderMatch(a,b){
    const remain = state.queue.length + state.next.length + 2;
    panel.innerHTML = `
      <div class="topline">
        <div class="step">토너먼트</div>
        <div class="counter">남은 후보: <b>${remain}</b></div>
      </div>
      <div class="matchGrid">
        <div class="match" id="mA">
          <div class="matchEn">${a.en}</div>
          <div class="matchKo">${a.ko}</div>
        </div>
        <div class="match" id="mB">
          <div class="matchEn">${b.en}</div>
          <div class="matchKo">${b.ko}</div>
        </div>
      </div>
    `;
    panel.querySelector("#mA").onclick = () => { state.next.push(a); stepMatch(); };
    panel.querySelector("#mB").onclick = () => { state.next.push(b); stepMatch(); };
  }

  // ====== result + downloads ======
  function renderDone(){
    state.mode = "done";
    hint.textContent = "다운로드";

    const word = state.final.en;

    panel.innerHTML = `
      <div class="topline">
        <div class="step">완료</div>
        <div class="counter">${state.bgReady ? "배경 OK" : "배경 필요"}</div>
      </div>
      <div class="resultWord">${word}</div>

      <div class="previewWrap">
        <div class="preview desk">
          <div class="img" id="prevDesk"></div>
          <div class="year" id="prevDeskYear"></div>
          <div class="word" id="prevDeskWord"></div>
          <div class="cap">PC</div>
        </div>
        <div class="preview mob">
          <div class="img" id="prevMob"></div>
          <div class="year" id="prevMobYear"></div>
          <div class="word" id="prevMobWord"></div>
          <div class="cap">폰</div>
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="dlD">PC 다운로드</button>
        <button class="btn primary" id="dlM">폰 다운로드</button>
        <button class="btn" id="dlB">둘 다</button>
      </div>
    `;

    const prevDesk = panel.querySelector("#prevDesk");
    const prevMob  = panel.querySelector("#prevMob");
    const prevDeskYear = panel.querySelector("#prevDeskYear");
    const prevMobYear  = panel.querySelector("#prevMobYear");
    const prevDeskWord = panel.querySelector("#prevDeskWord");
    const prevMobWord  = panel.querySelector("#prevMobWord");

    prevDesk.style.backgroundImage = `url(${state.bgImg.src || ""})`;
    prevMob.style.backgroundImage  = `url(${state.bgImg.src || ""})`;
    // apply overlay from tone analysis if available
    if(state.bgTone){
      prevDesk.style.backgroundImage = `linear-gradient(${state.bgTone.overlay}, ${state.bgTone.overlay}), url(${state.bgImg.src})`;
      prevMob.style.backgroundImage  = `linear-gradient(${state.bgTone.overlay}, ${state.bgTone.overlay}), url(${state.bgImg.src})`;
      prevDeskWord.style.color = state.bgTone.textColor;
      prevMobWord.style.color  = state.bgTone.textColor;
      prevDeskYear.style.color = state.bgTone.textColor === '#ffffff' ? 'rgba(255,255,255,0.45)' : 'rgba(0,0,0,0.6)';
      prevMobYear.style.color  = prevDeskYear.style.color;
    }
    prevDeskYear.textContent = YEAR_TEXT;
    prevMobYear.textContent  = YEAR_TEXT;
    prevDeskWord.textContent = word;
    prevMobWord.textContent  = word;

    prevDeskYear.style.top = "12%";
    prevMobYear.style.top  = "12%";
    prevDeskYear.style.fontSize = "34px";
    prevMobYear.style.fontSize  = "30px";
    prevDeskWord.style.fontSize = "72px";
    prevMobWord.style.fontSize  = "56px";
    prevDeskWord.style.bottom = ((1 - HORIZON_DESKTOP) * 100 + 2) + "%";
    prevMobWord.style.bottom  = ((1 - HORIZON_MOBILE)  * 100 + 2) + "%";

    panel.querySelector("#dlD").onclick = () => safeDownload("desktop", word);
    panel.querySelector("#dlM").onclick = () => safeDownload("mobile", word);
    panel.querySelector("#dlB").onclick = () => { safeDownload("desktop", word); setTimeout(()=>safeDownload("mobile", word), 260); };
  }

  // ====== canvas export (async safe load to avoid tainting issues) ======
  async function makeCanvas({w,h,word,year,horizonRatio,wordSize,yearSize, src}){
    // create an image instance specifically for export to ensure it's fully loaded and crossOrigin set appropriately
    const img = new Image();
    // determine source: provided src, selectedBgSrc, or state.bgImg.src
    const imageSrc = src || selectedBgSrc || state.bgImg.src;
    if(!imageSrc) throw new Error('배경 필요');

    if(/^https?:\/\//i.test(imageSrc)){
      img.crossOrigin = 'anonymous';
    }

    const loadImg = () => new Promise((resolve,reject)=>{
      img.onload = () => resolve(img);
      img.onerror = (e) => reject(new Error('이미지 로드 실패'));
      img.src = imageSrc;
    });

    await loadImg();

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', {alpha:false});
    const dpr = Math.min(window.devicePixelRatio||1, 2);
    canvas.width = Math.round(w*dpr);
    canvas.height = Math.round(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,w,h);

    const iw = img.naturalWidth || img.width, ih = img.naturalHeight || img.height;
    const scale = Math.max(w/iw, h/ih);
    const dw = iw*scale, dh = ih*scale;
    const dx = (w - dw)/2, dy = (h - dh)/2;
    ctx.drawImage(img, dx, dy, dw, dh);

    // overlay from tone if available (fall back to default)
    const overlay = (state.bgTone && state.bgTone.overlay) ? state.bgTone.overlay : `rgba(0,0,0,${OVERLAY_ALPHA})`;
    if(overlay) ctx.fillStyle = overlay, ctx.fillRect(0,0,w,h);

    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    const yearColor = (state.bgTone && state.bgTone.textColor) ? state.bgTone.textColor : 'rgba(255,255,255,0.45)';
    ctx.fillStyle = yearColor;
    ctx.font = `900 ${yearSize}px system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif`;
    ctx.fillText(year, w/2, h*0.16);

    let size = wordSize;
    const wordColor = (state.bgTone && state.bgTone.textColor) ? state.bgTone.textColor : '#ffffff';
    ctx.fillStyle = wordColor;
    ctx.font = `950 ${size}px system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif`;
    const maxWidth = w*0.86;
    while(ctx.measureText(word).width > maxWidth && size > 54){
      size -= 4;
      ctx.font = `950 ${size}px system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif`;
    }
    const horizonY = h*horizonRatio;
    const wordY = horizonY - (size*0.12);

    ctx.save();
    ctx.shadowColor = 'rgba(0,0,0,0.55)';
    ctx.shadowBlur = 26;
    ctx.shadowOffsetY = 10;
    ctx.fillText(word, w/2, wordY);
    ctx.restore();

    return canvas;
  }

  function downloadPng(canvas, filename){
    canvas.toBlob((blob)=>{
      if(!blob) return;
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }, "image/png");
  }

  async function safeDownload(type, word){
    try{
      const isDesk = (type==="desktop");
      const canvas = await makeCanvas({
        w: isDesk ? 1920 : 1080,
        h: isDesk ? 1080 : 1920,
        word,
        year: YEAR_TEXT,
        horizonRatio: isDesk ? HORIZON_DESKTOP : HORIZON_MOBILE,
        wordSize: isDesk ? WORD_SIZE_DESKTOP : WORD_SIZE_MOBILE,
        yearSize: isDesk ? YEAR_SIZE_DESKTOP : YEAR_SIZE_MOBILE,
        src: selectedBgSrc || state.bgImg.src
      });
      downloadPng(canvas, `oneword_${word}_${type}.png`);
    }catch(e){
      hint.textContent = "배경 선택 필요";
      console.error('safeDownload error', e);
    }
  }

  // ====== start ======
  init();
})();
</script>
</body>
</html>
